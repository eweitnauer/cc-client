// Copyright Erik Weitnauer 2014.
var uid=function(){var t=4294967296,e=15,r=[];str=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function a(){var a=0;var n=Math.random()*t;r[a++]=str[n&e];r[a++]=str[n>>>4&e];r[a++]=str[n>>>8&e];r[a++]=str[n>>>12&e];r[a++]=str[n>>>16&e];r[a++]=str[n>>>20&e];r[a++]=str[n>>>24&e];r[a++]=str[n>>>28&e];n=Math.random()*t;r[a++]=str[n&e];r[a++]=str[n>>>4&e];r[a++]=str[n>>>8&e];r[a++]=str[n>>>12&e];r[a++]=str[n>>>16&e];r[a++]=str[n>>>20&e];r[a++]=str[n>>>24&e];r[a++]=str[n>>>28&e];return"_"+r.join("")}return a}();function IntervalList(){this.ivs=[]}if(typeof exports!=="undefined")exports.IntervalList=IntervalList;IntervalList.prototype.overlap=function(t,e){return t[0]<e[1]&&e[0]<t[1]};IntervalList.prototype.overlapOrTouch=function(t,e){return t[0]<=e[1]&&e[0]<=t[1]};IntervalList.prototype.getMissingIntervals=function(t){var e=[];var r=t.slice();for(var a=0;a<this.ivs.length;a++){var n=this.ivs[a];if(!this.overlap(n,r)){if(n[0]>r[1])break;else continue}if(r[0]<n[0])e.push([r[0],n[0]]);r[0]=n[1]}if(r[1]>r[0])e.push(r);return e};IntervalList.prototype.insert=function(t){var e=-1,r=-1,a=0;for(var n=0;n<this.ivs.length;n++){var i=this.ivs[n];if(i[1]<t[0])a++;if(this.overlapOrTouch(i,t)){e=e===-1?n:e;r=n}else{if(e!==-1)break}}var s=e===-1?t[0]:Math.min(t[0],this.ivs[e][0]),o=r===-1?t[1]:Math.max(t[1],this.ivs[r][1]);if(e===-1)this.ivs.splice(a,0,[s,o]);else this.ivs.splice(e,r-e+1,[s,o])};function DataSource(t,e){var r=t.split("/");this.ex=r[0];this.pair=r[1];this.loaded_ivs={"1min":new IntervalList,"5min":new IntervalList,"30min":new IntervalList,"4h":new IntervalList,"1d":new IntervalList};this.data={"1min":[],"5min":[],"30min":[],"4h":[],"1d":[]};this.loading=false;this.bisect=d3.bisector(function(t){return t.time_end}).right;this.server_url=e||"http://localhost:3000"}DataSource.prototype.loadData=function(t,e,r){var a=this.loaded_ivs[e].getMissingIntervals(t);if(a.length===0)r(this.getDataFromCache(t,e));var n=a.length,i=this;var s=function(){n-=1;if(n===0){i.loading=false;r(i.getDataFromCache(t,e))}};this.loading=true;a.forEach(function(t){i.queryDataFromServer(t,e,s)})};DataSource.prototype.getDataFromCache=function(t,e,r){var a=this.data[e];var n=+new Date(t[0]),i=+new Date(t[1]);var s=this.bisect(a,n),o=this.bisect(a,i,s);var l=a.slice(s,o);if(r)r(l);return l};DataSource.prototype.queryDataFromServer=function(t,e,r){var a=200;var n=this.server_url+"/api/trades/"+this.ex+"/"+this.pair;n+="?limit="+a+"&group_by="+e+"&time="+t[0]+"&time_end="+t[1];var i=this;console.log("query from server:",t);d3.json(n,function(n){console.log("got",n&&n.length,"data points from the server");if(!n||n.length===0){r();return}i.convertDates(n);n.sort(function(t,e){return-e.time_start+t.time_start});i.insertData(n,e);if(n.length===a){console.info("more data on the server for this interval...");i.loaded_ivs[e].insert([n[0].time_start,t[1]]);i.queryDataFromServer([t[0],n[0].time_start],e,r)}else{i.loaded_ivs[e].insert(t);r()}})};DataSource.prototype.convertDates=function(t){for(var e=0;e<t.length;e++){t[e].time_start=+new Date(t[e].time_start);t[e].time_end=+new Date(t[e].time_end)}};DataSource.prototype.insertData=function(t,e){var r=t[0];var a=this.data[e];var n=this.bisect(a,r.time_start);this.data[e]=a.slice(0,n).concat(t).concat(a.slice(n))};function PlotData(t){t=t||{};this.label=t.label||"???";this.sources=t.sources||[];this.mode=t.mode||"vwap";this.group_by=t.group_by||"1min"}var VolumePlot=function(){var t,e,r,a=uid(),n=100,i=100,s,o,l,u,c,d=.25,f=d3.scale.category10(),p,v=false,h=d3.bisector(function(t){return t.time_end}).right,m=d3.bisector(function(t){return t.time_start}).right,_="volume",g;var y=function(t){l=t;y.init();return this};y.x_scale=function(t){if(arguments.length===0)return r;r=t;if(v)y.update_x(0);return this};y.color=function(t){if(arguments.length===0)return f;f=t;if(v)y.update_x(0);return this};y.size=function(e){if(arguments.length===0)return[n,i];n=e[0];i=e[1];if(v){t.range([i,0]);y.update(0);c.attr({width:n,height:i});o.attr("transform","translate("+n+",0)")}return this};y.vis_type=function(t){if(arguments.length===0)return _;_=t;if(v)y.clear();return this};y.data_layers=function(t,e){if(arguments.length===0)return p;p=t;if(v)y.update(e);return this};y.init=function(){v=true;t=d3.scale.linear().range([i,0]).domain([0,0]);c=l.append("clipPath").attr("id","clip_"+a).append("rect").attr({width:n,height:i});s=d3.svg.axis().scale(t).ticks(Math.round(i/20)).tickSize(i>100?-n:0).outerTickSize(0).orient("right");o=l.append("g").attr("class","y axis").attr("transform","translate("+n+",0)");l.append("rect").attr("width",n).attr("height",i).classed("border",true);u=l.append("g").attr("clip-path","url(#clip_"+a+")").append("g")};y.update=function(t){t=t||0;y.update_x_axis(t);y.scale_y_axis(t);var e=u.selectAll(".layer").data(p,function(t){return t.id});e.enter().append("g").classed("layer",true);e.exit().remove();e.each(function(e){var r=d3.select(this);y.update_layer(r,e,t)})};y.update_layer=function(t,e,r){if(_==="volume")y.update_volume_layer(t,e,r);if(_==="candles")y.update_candles_layer(t,e,r);if(_==="vwap")y.update_vwap_layer(t,e,r)};y.update_volume_layer=function(e,a,n){var i=f(a.id);var s=e.selectAll(".box");s=s.data(a.data,function(t){return t._id});var o,l;if(a.data.length>0)o=r(a.data[0].time_end)-r(a.data[0].time_start);l=o*d/2;o=o-2*l;var u=s.enter().append("g").attr("class","box").attr("transform",function(t){return"translate("+r(t.time_start)+",0)"}).style("opacity",1e-5);u.append("rect").attr("x",l).attr("width",o).attr("y",function(e){return t(e.volume)}).attr("height",function(e){return t(0)-t(e.volume)}).style("stroke",i).style("fill",i).style("fill-opacity",.3);s.transition().duration(n).attr("transform",function(t){return"translate("+r(t.time_start)+",0)"}).style("opacity",1).select("rect").attr("y",function(e){return t(e.volume)}).attr("height",function(e){return t(0)-t(e.volume)});s.exit().remove()};y.update_candles_layer=function(e,a,n){var i=f(a.id);var s=e.selectAll(".box");s=s.data(a.data,function(t){return t._id});var o,l;if(a.data.length>0)o=r(a.data[0].time_end)-r(a.data[0].time_start);l=o*d/2;o=o-2*l;var u=s.enter().append("g").attr("class","box").attr("transform",function(t){return"translate("+r(t.time_start)+",0)"}).style("opacity",1e-5);u.append("line").attr("x1",l+o/2).attr("x2",l+o/2).attr("y1",function(e){return t(e.price_min)}).attr("y2",function(e){return t(e.price_max)}).style("stroke","silver");u.append("rect").attr("x",l).attr("width",o).attr("y",function(e){return Math.min(t(e.price_start),t(e.price_end))}).attr("height",function(e){return Math.max(.5,Math.abs(-t(e.price_start)+t(e.price_end)))}).style("fill",function(t){return t.price_start<t.price_end?"#64FF64":"#FF6464"}).style("stroke","black");var c=s.transition().duration(n).attr("transform",function(t){return"translate("+r(t.time_start)+",0)"}).style("opacity",1);c.select("line").attr("y1",function(e){return t(e.price_min)}).attr("y2",function(e){return t(e.price_max)});c.select("rect").attr("y",function(e){return Math.min(t(e.price_start),t(e.price_end))}).attr("height",function(e){return Math.max(.5,Math.abs(-t(e.price_start)+t(e.price_end)))});s.exit().remove()};y.update_vwap_layer_single_path=function(a,n,i){var s=f(n.id);var o=a.selectAll("circle.vwap").data(n.data,function(t){return t._id});o.enter().append("circle").classed("vwap",true).style("fill",s).attr("r",1.5);o.transition().duration(i).attr("cx",function(t){return r((+t.time_start+ +t.time_end)/2)}).attr("cy",function(e){return t(e.vwap)});o.exit().remove();var l=a.selectAll("path.vwap").data([n.data]);l.enter().append("path").classed("vwap",true).style("fill","none").attr("d",g).style("stroke",s);if(i>0){var u=t.domain();if(e)t.domain(e);l.attr("d",g);t.domain(u)}l.transition().duration(i).attr("d",g);l.exit().remove()};y.set_vwap_line=function(e){e.style("display",function(t){var e=t[1].time_start-t[0].time_start;var r=t[0].time_end-t[0].time_start;return e<=3*r?"auto":"none"}).attr("x1",function(t){return r((+t[0].time_start+ +t[0].time_end)/2)}).attr("y1",function(e){return t(e[0].vwap)}).attr("x2",function(t){return r((+t[1].time_start+ +t[1].time_end)/2)}).attr("y2",function(e){return t(e[1].vwap)})};y.update_vwap_layer=function(a,n,i){var s=f(n.id);var o=a.selectAll("circle.vwap").data(n.data,function(t){return t._id});o.enter().append("circle").classed("vwap",true).style("fill",s).attr("r",1.5);var l=a.selectAll("line.vwap").data(d3.pairs(n.data),function(t){return t[0]._id});l.enter().append("line").classed("vwap",true).style("fill","none").call(this.set_vwap_line).style("stroke",s);if(i>0){var u=t.domain();if(e)t.domain(e);l.call(this.set_vwap_line);o.attr("cx",function(t){return r((+t.time_start+ +t.time_end)/2)}).attr("cy",function(e){return t(e.vwap)});t.domain(u)}o.transition().duration(i).attr("cx",function(t){return r((+t.time_start+ +t.time_end)/2)}).attr("cy",function(e){return t(e.vwap)});o.exit().remove();l.transition().duration(i).call(this.set_vwap_line);l.exit().remove()};y.scale_y_axis=function(a){var n=[],i=[];var l=d3.max(p,function(t){console.log(t);var e=h(t.data,r.domain()[0]),a=m(t.data,r.domain()[1],e),s=t.data.filter(function(t,r){return r>=e&&r<a});if(_==="volume"){i.push(d3.max(s,function(t){return t.volume}))}else{n.push(d3.min(s,function(t){return t.price_min}));i.push(d3.max(s,function(t){return t.price_max}))}});if(i.length===0||i[0]===undefined)return false;var u=_==="volume"?0:d3.min(n)||0,c=d3.max(i)||0,d=c-u,f=t.domain(),v=f[1]-f[0],g=_==="volume"?0:.2,y=_==="volume"?.1:.2;e=f;if(u<f[0]||u>f[0]+g*d||c>f[1]||c<f[1]-y*d){if(d===0)t.domain([u-v/2,c+v/2]);else t.domain([u-d*g/2,c+d*y/2]);s.scale(t);o.transition().duration(a).call(s);return true}return false};y.update_x_axis=function(t){};y.clear=function(){u.selectAll(".layer").remove()};y.shift_x=function(t,e){e=e||0;u.transition().duration(e).ease("linear").attr("transform","translate("+t+",0)")};return y};var MainPlot=function(){var t,e,r,a=300,n={top:10,right:70,bottom:10,left:10,between:35},i,s,o,l,u=[],c=null,d=.75,f=true,p="4h",v=["1min","5min","30min","4h","1d"],h="vwap",m=["vwap","candles"],_={"1min":1e3*60,"5min":1e3*60*5,"30min":1e3*60*30,"4h":1e3*3600*4,"1d":1e3*3600*24},g=10,y,x=d3.time.scale(),w,b,D=d3.scale.category10(),k=d3.time.format("%b/%d %I:%M:%S %p"),S,M,A,I,L=0;var C=function(t){e=d3.select(t);if(!c)c=Date.now();C.init();return this};var F=function(){return(a-n.between)*.8};var P=function(){return(a-n.between)*.2};C.width=function(){return o?o.node().getBoundingClientRect().width-n.left-n.right:0};C.addDataSource=function(t,e){if(typeof e==="undefined")e=true;u.push(t);t.active=e;t.idx=u.length-1;return this};C.label=function(e){if(arguments.length===0)return t;t=e;if(r)r.text(t);return this};C.height=function(t){if(arguments.length===0)return a;a=t;return this};C.int_mode=function(t){if(arguments.length===0)return p;p=t;if(o){C.clear();C.update()}return this};C.plot_type=function(t){if(arguments.length===0)return h;if(t!==h){if(t==="candles"){var e=0;for(var r=0;r<u.length;r++)if(u[r].active)e++;if(e>1){var a=0;for(var n=0;n<u.length;n++){if(a>0)u[n].active=false;if(u[n].active)a++}}C.updateLegend()}h=t;M.vis_type(t);C.update(true,false)}return this};C.time_end=function(t){if(arguments.length===0)return c;c=t;return this};C.init=function(){T();O()};C.clear=function(){M.clear();S.clear()};C.update=function(t,e){if(typeof t==="undefined")t=true;if(typeof e==="undefined")e=true;var r=j();var a=E();x.domain(r);var n=[],i=0;function s(r,a){if(r)n.push({id:r,data:a});if(++i==u.length){C.update_x_axis(250);if(t)M.data_layers(n,250);if(e)S.data_layers(n,250)}}u.forEach(function(t){if(!t.active)s();else t.loadData(a,p,function(e){s(t.ex,e)})})};C.shiftData=function(t){var e=x.invert(t)-x.invert(0);var r=x.domain();var a=x.range();t=x(e)-x(0);L+=t;c-=e;x.range([x(r[0]-e),x(r[1]-e)]);x.domain([r[0]-e,r[1]-e]);var i=b.transition().duration(0).ease("linear").attr("transform","translate("+L+",0)").call(w);i.selectAll("text").attr("y",-n.between/2+4);i.selectAll("line").style("stroke-dasharray",[5,n.between-10-1,5]);S.shift_x(L);M.shift_x(L)};C.update_x_axis=function(t){var e=b.transition().duration(t).call(w);e.selectAll("text").attr("y",-n.between/2+4);e.selectAll("line").style("stroke-dasharray",[5,n.between-10-1,5])};function z(){A.attr("display","none");f=false;var t=d3.event.dx;if(!t)return;C.shiftData(t)}function q(){A.attr("display","auto");C.update()}function T(){var c=d3.behavior.drag().origin(function(t){return{x:0,y:0}}).on("drag",z).on("dragend",q);s=e.append("div").classed("right-col-wrapper",true).append("div").classed("right-col",true);i=e.append("div").classed("left-col",true);r=i.append("h2").text(t);var d=i.append("div").classed("interval-selection",true).selectAll("div.selector").data(v).enter().append("div").classed("selector",true).classed("selected",function(t){return t===p}).text(function(t){return{"1min":"1 min","5min":"5 min","30min":"30 min","4h":"4 h","1d":"1 d"}[t]}).on("click",function(t){d.classed("selected",false);d3.select(this).classed("selected",true);C.int_mode(t)});var f=i.append("div").classed("plot-type-selection",true).selectAll("div.selector").data(m).enter().append("div").classed("selector",true).classed("selected",function(t){return t===h}).text(function(t){return t}).on("click",function(t){f.classed("selected",false);d3.select(this).classed("selected",true);C.plot_type(t)});y=i.append("div").classed("legend",true).selectAll("div.legend-item").data(u).enter().append("div").classed("legend-item",true);y.append("span").classed("label",true).text(function(t){return t.ex}).on("click",C.toggleSource);y.append("span").classed("marker",true).on("click",C.toggleSource);C.updateLegend();o=s.append("svg").attr({width:"100%",height:a+n.top+n.bottom+n.between});l=o.append("g").attr("transform","translate("+n.left+","+n.top+")");o.append("rect").style({fill:"none",stroke:"none","pointer-events":"all"}).attr({width:"100%",height:"100%"}).on("mousemove",function(){var t=d3.mouse(l.node());var e=x.invert(t[0]-L);A.attr("transform","translate("+(t[0]-.5)+",0)");I.text(k(e))}).on("mouseleave",function(){A.attr("display","none")}).on("mouseenter",function(){A.attr("display","auto")}).call(c);w=d3.svg.axis().scale(x).orient("top").outerTickSize(0).tickSize(n.between).tickPadding(0);b=l.append("g").attr("transform","translate(0, "+(F()+n.between)+")").append("g").attr("class","x axis");l.append("g").classed("price-plot",true);l.append("g").classed("volume-plot",true).attr("transform","translate(0, "+(F()+n.between)+")");A=l.append("g").attr("transform","translate(0,0)").attr("display","none");A.append("line").classed("ruler",true).attr({y1:0,y2:a});A.append("rect").attr({fill:"white",rx:3,ry:3,stroke:"silver",width:100,height:16,x:-50,y:F()+n.between/2-6});I=A.append("text").classed("ruler-text",true).attr({x:-46,y:F()+n.between/2+5})}C.toggleSource=function(t){var e=0;for(var r=0;r<u.length;r++)if(u[r].active)e++;if(e===1){if(h==="candles"){for(var r=0;r<u.length;r++)u[r].active=false}}t.active=!t.active;C.updateLegend();C.update()};C.updateLegend=function(){y.select(".marker").style("background",function(t){return t.active?D(t.ex):"silver"})};function j(){var t=f?Date.now():c;c=t;return[Math.round(t-C.width()/g*_[p]),t]}function E(){var t=j();t[0]-=d*(t[1]-t[0]);t[1]+=d*(t[1]-t[0]);return[t[0],t[1]]}function O(){x.range([0,C.width()]);D=d3.scale.category10();M=VolumePlot().x_scale(x).size([C.width(),F()]).color(D).vis_type(h);o.select(".price-plot").call(M);S=VolumePlot().x_scale(x).size([C.width(),P()]).color(D).vis_type("volume");o.select(".volume-plot").call(S);C.update()}return C};CCClient={};CCClient.init=function(t){var e=[];var r={};a(s);function a(a){var n=t+"/api/trades/";d3.json(n,function(n){for(var i in n){var s=n[i];for(var o=0;o<s.length;o++){if(s[o]!=="btc_usd")continue;addServerPair(s[o],i)}}console.log(r);for(var l in r){var u=MainPlot().label(l);for(var o=0;o<r[l].length;o++){var c=r[l][o];u.addDataSource(new DataSource(c.ex+"/"+c.pair,t),true)}e.push(u)}a()})}function n(t){var e;if(t.indexOf("_")===-1){e=[t.substring(0,3),t.substring(3)]}else e=t.split("_");return e[0].toUpperCase()+" / "+e[1].toUpperCase()}function i(t){var e=n(t).split(" / ");return e[1]+" / "+e[0]}addServerPair=function(t,e){var a=n(t);var s=i(t);var o;if(a in r||!(s in r))o=a;else o=s;r[o]=r[o]||[];r[o].push({ex:e,pair:t})};function s(){var t=d3.select("body").selectAll("div.plot").data(e);var r=t.enter().append("div").classed("plot",true).each(function(t){t(this)});setInterval(o,6e4)}function o(){e.forEach(function(t){t.update()})}};